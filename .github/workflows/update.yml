name: Update AUR Package

on:
  schedule:
    # Check for updates weekly (Monday at 00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      version:
        description: 'Specific version to update to (optional, e.g., 6.9.0)'
        required: false

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new version
        id: check-version
        run: |
          # 获取当前版本
          CURRENT=$(grep "^pkgver=" PKGBUILD | cut -d'=' -f2)
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          # 尝试从网页获取最新版本（需要手动更新这个逻辑）
          # 这里只是一个示例，实际需要根据官方下载页面调整
          
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # 默认保持当前版本，需要手动触发更新
            VERSION="$CURRENT"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT" != "$VERSION" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed: $CURRENT -> $VERSION"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "No update needed"
          fi

      - name: Update PKGBUILD
        if: steps.check-version.outputs.update_needed == 'true'
        run: |
          VERSION="${{ steps.check-version.outputs.version }}"
          
          # Update version
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          
          # Update download URL
          sed -i "s|adrive-desktop-[0-9.]\+-windows|adrive-desktop-${VERSION}-windows|g" PKGBUILD
          
          echo "Updated PKGBUILD to version ${VERSION}"

      - name: Update .SRCINFO
        if: steps.check-version.outputs.update_needed == 'true'
        run: |
          VERSION="${{ steps.check-version.outputs.version }}"
          
          sed -i "s/pkgver = .*/pkgver = ${VERSION}/" .SRCINFO
          sed -i "s|adrive-desktop-[0-9.]\+-windows|adrive-desktop-${VERSION}-windows|g" .SRCINFO

      - name: Commit and push changes
        if: steps.check-version.outputs.update_needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to v${{ steps.check-version.outputs.version }}"
          git push

      - name: Create summary
        run: |
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-version.outputs.update_needed }}" == "true" ]; then
            echo "✅ Updated to \`${{ steps.check-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No update needed. Current version: \`${{ steps.check-version.outputs.current }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To manually update, trigger workflow with version input." >> $GITHUB_STEP_SUMMARY
          fi
